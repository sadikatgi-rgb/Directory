import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyAwJCSwpj9EOd40IJrmI7drsURumljWRo8",
    authDomain: "directory-f4474.firebaseapp.com",
    projectId: "directory-f4474",
    storageBucket: "directory-f4474.firebasestorage.app",
    messagingSenderId: "681119733857",
    appId: "1:681119733857:web:e77d5ab9571a35aff1f220"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;

// ‡¥ì‡¥∞‡µã ‡¥µ‡¥ø‡¥≠‡¥æ‡¥ó‡¥§‡µç‡¥§‡¥ø‡¥®‡µÅ‡¥Ç ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥æ‡¥Ø ‡¥´‡µÄ‡µΩ‡¥°‡µÅ‡¥ï‡µæ
const categoryConfig = {
    'auto': { 'name': '‡¥™‡µá‡¥∞‡µç', 'place': '‡¥∏‡µç‡¥•‡¥≤‡¥Ç', 'phone': '‡¥´‡µã‡µ∫', 'no': '‡¥µ‡¥æ‡¥π‡¥® ‡¥®‡¥Æ‡µç‡¥™‡µº' },
    'shops': { 'name': '‡¥ï‡¥ü‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç', 'place': '‡¥∏‡µç‡¥•‡¥≤‡¥Ç', 'phone': '‡¥´‡µã‡µ∫', 'item': '‡¥™‡µç‡¥∞‡¥ß‡¥æ‡¥® ‡¥µ‡¥ø‡¥≠‡¥µ‡¥Ç' },
    'workers': { 'name': '‡¥™‡µá‡¥∞‡µç', 'place': '‡¥∏‡µç‡¥•‡¥≤‡¥Ç', 'phone': '‡¥´‡µã‡µ∫', 'job': '‡¥ú‡µã‡¥≤‡¥ø' },
    'catering': { 'name': '‡¥™‡µá‡¥∞‡µç', 'place': '‡¥∏‡µç‡¥•‡¥≤‡¥Ç', 'phone': '‡¥´‡µã‡µ∫', 'specialty': '‡¥™‡µç‡¥∞‡¥§‡µç‡¥Ø‡µá‡¥ï‡¥§' },
    'default': { 'name': '‡¥™‡µá‡¥∞‡µç', 'place': '‡¥∏‡µç‡¥•‡¥≤‡¥Ç', 'phone': '‡¥´‡µã‡µ∫' }
};

// Splash Screen ‡¥®‡¥ø‡¥Ø‡¥®‡µç‡¥§‡µç‡¥∞‡¥£‡¥Ç
window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const splash = document.getElementById('splash');
        if(splash) {
            splash.style.opacity = '0';
            setTimeout(() => splash.classList.add('hidden'), 800);
        }
    }, 2500);
});

// ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥™‡¥æ‡¥®‡¥≤‡¥ø‡µΩ ‡¥´‡µÄ‡µΩ‡¥°‡µÅ‡¥ï‡µæ ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥æ‡µª
window.renderAdminFields = () => {
    const cat = document.getElementById('new-cat').value;
    const container = document.getElementById('dynamic-inputs');
    const fields = categoryConfig[cat] || categoryConfig['default'];
    container.innerHTML = ""; 
    for (let key in fields) {
        container.innerHTML += `<input type="text" id="field-${key}" placeholder="${fields[key]}">`;
    }
};

// ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µÄ‡¥®‡µÅ‡¥ï‡µæ ‡¥í‡¥≥‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª
function hideAll() {
    const screens = ['home-screen', 'content-info-screen', 'admin-login-screen', 'admin-panel', 'list-screen', 'about-app-screen', 'leaders-screen'];
    screens.forEach(s => {
        const el = document.getElementById(s);
        if(el) el.classList.add('hidden');
    });
    const container = document.getElementById('main-container');
    if(container) container.scrollTop = 0;
}

// ‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª
window.handleSaveData = async () => {
    const cat = document.getElementById('new-cat').value;
    const fields = categoryConfig[cat] || categoryConfig['default'];
    let dataToSave = {};

    for (let key in fields) {
        const val = document.getElementById(`field-${key}`).value;
        if (!val) { alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥ï‡µã‡¥≥‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥™‡µÇ‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï!"); return; }
        dataToSave[key] = val;
    }

    try {
        await addDoc(collection(db, cat), dataToSave);
        alert("‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡µÅ!");
        renderAdminFields(); 
    } catch (e) { alert("Error saving data!"); }
};

// ‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª
window.deleteEntry = async (catId, docId) => {
    if (confirm("‡¥à ‡¥µ‡¥ø‡¥µ‡¥∞‡¥Ç ‡¥®‡µÄ‡¥ï‡µç‡¥ï‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ?")) {
        try {
            await deleteDoc(doc(db, catId, docId));
            alert("‡¥®‡µÄ‡¥ï‡µç‡¥ï‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
            showHome(); 
        } catch (e) { alert("Error deleting!"); }
    }
};

// ‡¥é‡¥°‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª
window.editEntry = async (catId, docId, currentDataStr) => {
    const currentData = JSON.parse(decodeURIComponent(currentDataStr));
    const fields = categoryConfig[catId] || categoryConfig['default'];
    let newData = {};
    
    for (let key in fields) {
        const val = prompt(`${fields[key]} ‡¥§‡¥ø‡¥∞‡µÅ‡¥§‡µç‡¥§‡µÅ‡¥ï:`, currentData[key] || "");
        if (val === null) return; 
        newData[key] = val;
    }

    try {
        await updateDoc(doc(db, catId, docId), newData);
        alert("‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥™‡µÅ‡¥§‡µÅ‡¥ï‡µç‡¥ï‡¥ø!");
        showHome();
    } catch (e) { alert("Error updating!"); }
};

// ‡¥ï‡¥æ‡¥±‡µç‡¥±‡¥ó‡¥±‡¥ø ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª (‡¥™‡µç‡¥∞‡µä‡¥´‡¥∑‡¥£‡µΩ ‡¥≤‡µÅ‡¥ï‡µç‡¥ï‡µç)
window.openCategory = async (catId, catName) => {
    hideAll();
    const listScreen = document.getElementById('list-screen');
    listScreen.classList.remove('hidden');
    document.getElementById('current-cat-title').innerText = catName;
    const container = document.getElementById('list-container');
    container.innerHTML = "<p style='text-align:center;'>‡¥∂‡µá‡¥ñ‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ...</p>";

    try {
        const querySnapshot = await getDocs(collection(db, catId));
        container.innerHTML = "";
        
        if (querySnapshot.empty) {
            container.innerHTML = "<p style='text-align:center; padding:20px;'>‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥≤‡µç‡¥≤</p>";
            return;
        }

        querySnapshot.forEach(docSnap => {
            const d = docSnap.data();
            const id = docSnap.id;
            const dataStr = encodeURIComponent(JSON.stringify(d));
            
            // ‡¥Ö‡¥ß‡¥ø‡¥ï ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥ì‡¥ü‡µç‡¥ü‡µã‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
            let extraInfo = "";
            for (let key in d) {
                if (key !== 'name' && key !== 'phone' && key !== 'place') {
                    const label = categoryConfig[catId] && categoryConfig[catId][key] ? categoryConfig[catId][key] : key;
                    extraInfo += `<small style="display:block; color:#555;"><b>${label}:</b> ${d[key]}</small>`;
                }
            }

            let adminSection = '';
            if(currentUser) {
                adminSection = `
                    <div class="admin-btns">
                        <button class="edit-btn" onclick="editEntry('${catId}', '${id}', '${dataStr}')">Edit</button>
                        <button class="delete-btn" onclick="deleteEntry('${catId}', '${id}')">Delete</button>
                    </div>`;
            }

            container.innerHTML += `
                <div class="person-card">
                    <div class="person-info">
                        <strong>${d.name}</strong>
                        <small style="display:block; margin-bottom:2px;">üìç ${d.place}</small>
                        <small style="display:block; margin-bottom:5px;">üìû ${d.phone}</small>
                        ${extraInfo}
                    </div>
                    <div class="action-buttons">
                        <a href="tel:${d.phone}" class="call-btn">üìû</a>
                    </div>
                    ${adminSection}
                </div>`;
        });
    } catch (e) { container.innerHTML = "Error!"; }
};

// ‡¥§‡¥ø‡¥∞‡¥ö‡µç‡¥ö‡¥ø‡µΩ (Search) ‡¥´‡¥Ç‡¥ó‡µç‡¥∑‡µª
window.filterResults = () => {
    const input = document.getElementById('search-input');
    const filter = input.value.toLowerCase();
    const container = document.getElementById('list-container');
    const cards = container.getElementsByClassName('person-card');

    for (let i = 0; i < cards.length; i++) {
        const info = cards[i].getElementsByClassName('person-info')[0];
        const text = info.textContent || info.innerText;
        
        if (text.toLowerCase().indexOf(filter) > -1) {
            cards[i].style.display = ""; 
        } else {
            cards[i].style.display = "none"; 
        }
    }
};

// ‡¥®‡¥æ‡¥µ‡¥ø‡¥ó‡µá‡¥∑‡µª ‡¥´‡¥Ç‡¥ó‡µç‡¥∑‡¥®‡µÅ‡¥ï‡µæ
window.toggleMenu = () => {
    document.getElementById('sidebar').classList.toggle('active');
    const overlay = document.getElementById('overlay');
    overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
};

window.showHome = () => {
    hideAll();
    document.getElementById('home-screen').classList.remove('hidden');
    document.getElementById('sidebar').classList.remove('active');
    document.getElementById('overlay').style.display = 'none';
};

window.showContentPage = () => { hideAll(); document.getElementById('content-info-screen').classList.remove('hidden'); toggleMenu(); };
window.showAboutApp = () => { hideAll(); document.getElementById('about-app-screen').classList.remove('hidden'); toggleMenu(); };
window.showLeaders = () => { hideAll(); document.getElementById('leaders-screen').classList.remove('hidden'); toggleMenu(); };
window.showAdminLogin = () => { 
    hideAll(); 
    if (currentUser) {
        document.getElementById('admin-panel').classList.remove('hidden');
        renderAdminFields(); 
    }
    else document.getElementById('admin-login-screen').classList.remove('hidden');
    toggleMenu(); 
};

window.handleLogin = async () => {
    const id = document.getElementById('admin-email').value.trim();
    const pass = document.getElementById('admin-password').value;
    try {
        await signInWithEmailAndPassword(auth, id + "@sys.com", pass);
        alert("‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ö‡µç‡¥ö‡µÅ!");
        showHome();
    } catch (e) { alert("‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥Ø ‡¥µ‡¥ø‡¥µ‡¥∞‡¥Ç!"); }
};

window.handleLogout = () => { signOut(auth); location.reload(); };
onAuthStateChanged(auth, (user) => { currentUser = user; });
